## 第六章 Redis分布系统

> Redis 分布系统，官方称为Redis Cluster，分布式（Distributed）
>
> Redis 分布式系统，官方称为 Redis Cluster，Redis 集群，其是 Redis 3.0 开始推出的分布 式解决方案。**其可以很好地解决不同 Redis 节点存放不同数据，并将用户请求方便地路由到不同 Redis 的问题。**



`redis-cli -c -p 6380`连接集群，`-c`是要连接集群。



### 数据分区算法

> 分布式数据库系统会根据不同的数据分区算法，将数据分散存储到不同的数据库服务器
>
> 节点上，每个节点管理着整个数据集合的一个子集。

#### 顺序分区算法

> 顺序分区规则可以将数据按照某种顺序平均分配到不同的节点。不同的顺序方式，产生 了不同的分区算法。例如，轮询分区算法、时间片轮转分区算法、数据块分区算法、业务主 题分区算法等。由于这些算法都比较简单，所以这里就不展开描述了。

##### 轮询分区算法

每产生一个数据，就依次分配到不同的节点。该算法适合于数据问题不确定的场景。其 分配的结果是，在数据总量非常庞大的情况下，每个节点中数据是很平均的。但生产者与数 据节点间的连接要长时间保持

##### 时间片轮转分区算法

在某人**固定长度的时间片内的数据**都会分配到一个节点。时间片结束，再产生的数据就 会被分配到下一个节点。这些节点会被依次轮转分配数据。该算法可能会出现节点数据不平 均的情况（因为每个时间片内产生的数据量可能是不同的）。但生产者与节点间的连接只需 占用当前正在使用的这个就可以，其它连接使用完毕后就立即释放

##### 数据块分区算法

在整体数据总量确定的情况下，根据各个节点的存储能力，可以将连接的某一整块数据 分配到某一节点

##### 业务主题分区算法

数据可根据不同的业务主题，分配到不同的节点



#### 哈希分区

> 哈希分区规则是**充分利用数据的哈希值来完成分配**，对数据哈希值的不同使用方式产生 了不同的哈希分区算法。哈希分区算法相对较复杂，这里详细介绍几种常见的哈希分区算法。

##### **节点取模分区算法**：

每个节点提前分配好了一个唯一序号，对于N个节点的分布式系统，序号范围[0,N-1]。当一个数据进来时，选取数据本身或可以代表数据特征的数据的一部分作为key，计算hash（key）与节点数量N的模（一定会落在[0,N-1]的范围内），该计算结果即为数据的存储节点的序号。

**该算法的优点是简单，但其也存在较严重的不足。如果分布式系统扩容或缩容，已经存储过的数据需要根据新的节点数量N进行重新计算迁移，否则无法根据key找到数据。**

生产中扩容一般采用翻倍扩容方式，以减少扩容时数据迁移的比例。

##### **一致性哈希分区算法：**

一致性hash算法通过一个叫做一致性hash环的数据结构实现。这个环的起点是0.终点是2^32-1 ,并且起点与终点重合。环中间的整数按逆/顺时针分布，整数分布范围是[0,2^32-1]。

假如有三个服务器节点，会根据服务器节点的ID来计算hash值，对应hash环上的点位，然后当有数据进来时，会根据数据的特征值来计算hash值，然后**会根据环的逆/顺时针方向存储到离他最近的服务器节点上去**。

该算法的最大优点是，节点的扩容与缩容，仅按照逆/顺时针方向距离该节点最近的节点由影响，对其它节点无影响。

当服务器节点数量较少时，非常容易形成数据倾斜问题，且节点变化影响的节点数量占比较大， 即影响的数据量较大。所以，该方式不适合数据节点较少的场景。

![](image\屏幕截图 2024-01-16 230411.png)



##### **☆虚拟槽分区算法：**

该算法首先虚拟出一个固定数量的整数集合，该集合中的每个整数称为一个 slot 槽。这 个槽的数量一般是远远大于节点数量的。然后再将所有 slot 槽平均映射到各个节点之上。例 如，Redis 分布式系统中共虚拟了 16384 （2^14）个slot槽。个 slot 槽，其范围为[0, 16383]。假设共有 3 个节点， 那么 slot 槽与节点间的映射关系如下图所示：

![](image\屏幕截图 2024-01-16 230621.png)





而数据只与 slot 槽有关系，与节点没有直接关系。**数据只通过其 key 的 hash(key)映射到 slot 槽：slot = hash(key) % slotNums。**这也是该算法的一个优点，解耦了数据与节点，客户端 无需维护节点，只需维护与 slot 槽的关系即可。 Redis 数据分区采用的就是该算法。其计算槽点的公式为：slot = CRC16(key) % 16384。 CRC16()是一种带有校验功能的、具有良好分散功能的、特殊的 hash 算法函数

其实Redis中计算槽点的公式不是上面的那个，而是：slot = CRC16(key)&16383

例如要计算 `a % b`，如果 b 是 2 的整数次幂，那么 `a % b = a & (b - 1)`。

**因为运用位运算速度更快，可以提高性能。**

#### Dubbo的负载均衡算法：

> Dubbo的负载均衡算法是一致性Hash算法与虚拟槽分区算法的结合，如果单用一致性Hash算法，当要扩容服务器节点减去所有服务器的负载时，只能影响根据环方向距离最近的服务器节点，无法整体减轻服务器的负载。

**解决方案：利用虚拟槽分区**

会为每台物理机各虚拟出360个虚拟机，然后分布在hash环上，虚拟机就是物理机的映射，当请求的特征性的hash值对应的虚拟机就选择对应的物理机，当增加物理机时，就讲其映射分布在hash环上。

### 系统搭建与运行

由于是模拟集群的情况，所以用不同的端口号来代表不同的主机。



vim编辑

`%s/6380/6382`将6380替换成6382。

编写测试用的启动脚本`start-redis-cluster.sh`

![](image\屏幕截图 2023-09-26 223244.png)

修改文件权限，变成可执行文件：

`chmod 755 start-redis-cluster.sh`



当写入数据时会根据数据分区分区到不同的主机，然后会重定向到写入数据的主机



`cluster keyslot`、`cluster countkeysinslot`、`cluster getkeysinslot`等集群查询指令，只能查询当前主机上的slot



事务支持有限，只能在事务中操作在同一个分区的slot



### 分布式系统的限制

Redis 的分布式系统存在一些使用限制： 

* 仅支持 0 号数据库 
* 批量 key 操作支持有限 
* 分区仅限于 key 
* 事务支持有限 
* 不支持分级管