# 日志系统设计

## 日志系统的设计步骤

* **确定需求**：首先确定需要记录哪些信息，例如设备连接和断开、设备状态变化、用户操作日志等。根据需求确定日志的级别和格式。
* **设计日志模块**：设计一个专门负责记录日志的模块，将其集成到智能网关的软件系统中。该模块一个有以下功能：
  * 日志记录：根据需求将相应的日志信息记录下来，包括时间戳、日志级别、设备信息、事件描述等。
  * 日志存储：将日志信息存储到适当的存储介质中，如本地文件、数据库等。
  * 日志管理：提供功能丰富的日志管理接口，如查询、导出、删除等操作，以便管理员能方便地管理和检索日志信息。
* **实现日志记录**：在关键的代码逻辑处插入日志记录的代码，确保关键操作的日志能够被记录下来。可以使用条件编译的方式来控制日志的级别，以便根据需要开启或关闭某些日志记录。
* **日志分析和和展示**：提供日志分析工具或界面，以便管理员可以对日志进行查看和分析。可以根据需要开发相应的查询和过滤功能，以方便快速定位和分析日志中的问题。
* **日志优化**：为了减少日志记录对系统性能的影响，可以考虑采用异步记录日志的方式，将日志记录的操作放入独立的线程或进程中进行。此外，还可以进行日志压缩和定期清理等优化措施，以减少日志存储占用的空间和提高查询性能。

## log4j

> Log4j有三个主要组件：**记录器**，**appender（追加器）**和**布局**。这三种类型的组件协同工作，使开发人员能够根据消息类型和级别记录消息，并在运行时控制这些消息的格式和报告位置。

### 一、引入Log4j

```xml
 <dependency>
         <groupId>log4j</groupId>
         <artifactId>log4j</artifactId>
         <version>1.2.17</version>
 </dependency>
```

### 二、log4j的配置

#### 2.1大致框架

Log4j 建议只使用四个级别，优先级从高到低分别是 **ERROR、WARN、INFO、DEBUG。**

```txt
debug：需要在调试过程中输出的信息，但发布后是不需要的（当然发布后，也是看不到的）

info：需要持续输出的信息（无论调试还是发布状态）

warn：警告级别的信息（不严重）

error：错误信息（较严重）

fatal：严重错误（特别严重，比如引起崩溃式的错误）
```

**ALL < DEBUG < INFO <WARN < ERROR < FATAL < OFF**

比如定义了 INFO 级别，只有等于及高于这个级别的才进行处理，则应用程序中所有 DEBUG 级别的日志信息将不被打印出来。ALL，打印所有的日志；OFF，关闭所有的日志输出。

appenderName，就是指定日志信息输出到哪个地方。可同时指定多个输出目的地。

在 src 根目录下建立 log4j.properties，根据自己的需求，相应的修改其中的配置，其内容如下所示：

```properties

```

![Log4J](https://img2018.cnblogs.com/blog/1322310/201904/1322310-20190428075356355-874614587.png)

- `Logger` - 日志写出器，供程序员输出日志信息
- `Appender` - 日志目的地，把格式化好的日志信息输出到指定的地方去
  - `ConsoleAppender` - 目的地为控制台的 Appender
  - `FileAppender` - 目的地为文件的 Appender
  - `RollingFileAppender` - 目的地为大小受限的文件的 Appender
- Layout - 日志格式化器，用来把程序员的 logging request 格式化成字符串
  - `PatternLayout` - 用指定的 pattern 格式化 logging request 的 Layout

#### 2.2配置根Logger

```properties
log4j.rootLogger = level,appenderName1,appenderName2
```

在这里定义了 INFO 级别，则应用程序中所有 DEBUG 级别的日志信息将不被打印出来。 `appenderName` 就是指 B 日志信息输出到哪个地方。您可以同时指定多个输出目的地。

#### 2.3配置日志信息输出目的地Appender

```properties
log4j.appender.appenderName = Log4j提供的appender类
log4j.appender.appenderName.属性名 = 属性值
log4j.appender.appenderName.属性名 = 属性值
```

其中，Log4j 提供的 appender 有以下几种：

- org.apache.log4j.ConsoleAppender（控制台），
- org.apache.log4j.FileAppender（文件），
- org.apache.log4j.DailyRollingFileAppender（每天产生一个日志文件），
- org.apache.log4j.RollingFileAppender（文件大小到达指定尺寸的时候产生一个新的文件），
- org.apache.log4j.WriterAppender（将日志信息以流格式发送到任意指定的地方）

**1) `ConsoleAppender` 选项**

`Threshold=WARN`:指定日志消息的输出最低层次。
`ImmediateFlush=true`:默认值是true,意谓着所有的消息都会被立即输出。
Target=System.err：默认情况下是：System.out,指定输出控制台

**2) `FileAppender` 选项**

`Threshold=WARN`:指定日志消息的输出最低层次。
`ImmediateFlush=true`:默认值是true,意谓着所有的消息都会被立即输出。
`File=mylog.txt`:指定消息输出到mylog.txt文件。
`Append=false`:默认值是true,即将消息增加到指定文件中，false指将消息覆盖指定的文件内容。

**3) `DailyRollingFileAppender` 选项**

`Threshold=WARN`:指定日志消息的输出最低层次。
`ImmediateFlush=true`:默认值是true,意谓着所有的消息都会被立即输出。
`File=mylog.txt`:指定消息输出到mylog.txt文件。
`Append=false`:默认值是true,即将消息增加到指定文件中，false指将消息覆盖指定的文件内容。
DatePattern=''.''yyyy-ww:每周滚动一次文件，即每周产生一个新的文件。

当然也可以指定按月、周、天、时和分。即对应的格式如下：

1)''.''yyyy-MM: 每月
2)''.''yyyy-ww: 每周
3)''.''yyyy-MM-dd: 每天
4)''.''yyyy-MM-dd-a: 每天两次
5)''.''yyyy-MM-dd-HH: 每小时
6)''.''yyyy-MM-dd-HH-mm: 每分钟

**4) `RollingFileAppender` 选项**

`Threshold=WARN`:指定日志消息的输出最低层次。
`ImmediateFlush=true`:默认值是true,意谓着所有的消息都会被立即输出。
`File=mylog.txt`:指定消息输出到mylog.txt文件。
`Append=false`:默认值是true,即将消息增加到指定文件中，false指将消息覆盖指定的文件内容。
`MaxFileSize=100KB`: 后缀可以是KB, MB 或者是 GB. 在日志文件到达该大小时，将会自动滚动，即将原来的内容移到 mylog.log.1 文件。
`MaxBackupIndex=2`:指定可以产生的滚动文件的最大数。

#### 2.4配置日志信息的格式（布局）

```properties
log4j.appender.appenderName.layout = Log4j提供的layout类
log4j.appender.appenderName.layout.属性 = 值
log4j.appender.appenderName.layout.属性 = 值
```

其中，Log4j 提供的 layout 有以下几种：

- org.apache.log4j.HTMLLayout（以HTML表格形式布局），
- org.apache.log4j.PatternLayout（可以灵活地指定布局模式），
- org.apache.log4j.SimpleLayout（包含日志信息的级别和信息字符串），
- org.apache.log4j.TTCCLayout（包含日志产生的时间、线程、类别等等信息）

**1) HTMLLayout选项**

LocationInfo=true:默认值是false,输出java文件名称和行号
Title=my app file: 默认值是 Log4J Log Messages.

**2) PatternLayout选项**

ConversionPattern=%m%n :指定怎样格式化指定的消息。

**3) XMLLayout选项**

LocationInfo=true:默认值是 false,输出 java 文件和行号

Log4J采用类似C语言中的printf函数的打印格式格式化日志信息，打印参数如下：

`og4j.appender.A1.layout.ConversionPattern=%-4r %-5p %d{yyyy-MM-dd HH:mm:ssS} %c %m%n`
这里需要说明的就是日志信息格式中几个符号所代表的含义：

-X号: X信息输出时左对齐；
%p: 输出日志信息优先级，即DEBUG，INFO，WARN，ERROR，FATAL,
%d: 输出日志时间点的日期或时间，默认格式为ISO8601，也可以在其后指定格式，
比如：%d{yyy MMM dd HH:mm:ss,SSS}，输出类似：2002年10月18日 22：10：28，921
%r: 输出自应用启动到输出该log信息耗费的毫秒数
%c: 输出日志信息所属的类目，通常就是所在类的全名
%t: 输出产生该日志事件的线程名
%l: 输出日志事件的发生位置，相当于%C.%M(%F:%L)的组合,包括类目名、发生的线程，以及行数。
举例：`Testlog4.main(TestLog4.java:10)`
%x: 输出和当前线程相关联的NDC(嵌套诊断环境)，尤其用到像java servlets这样的多客户多线程的应用中。
%%: 输出一个"%"字符
%F: 输出日志消息产生时所在的文件名称
%L: 输出代码中的行号
%m: 输出代码中指定的消息,产生的日志具体信息
%n: 输出一个回车换行符，Windows平台为"\r\n"，Unix平台为"\n"输出日志信息换行

可以在%与模式字符之间加上修饰符来控制其最小宽度、最大宽度、和文本的对齐方式。如：

1)%20c：指定输出category的名称，最小的宽度是20，如果category的名称小于20的话，默认的情况下右对齐。
2)%-20c:指定输出category的名称，最小的宽度是20，如果category的名称小于20的话，"-"号指定左对齐。
3)%.30c:指定输出category的名称，最大的宽度是30，如果category的名称大于30的话，就会将左边多出的字符截掉，但小于30的话也不会有空格。
4)%20.30c:如果category的名称小于20就补空格，并且右对齐，如果其名称长于30字符，就从左边交远销出的字符截掉

#### 2.5例子

```properties
#配置根Logger
    #改代码表示输出info级别以上的日志，文件分别输出，一个是file，一个是error
    log4j.rootLogger=info,file,error
    
    #配置file日志信息输出目的地Appender
    #定义名为file的输出端是每天产生一个日志文件
    log4j.appender.file=org.apache.log4j.DailyRollingFileAppender
    
    #指定日志信息的最低输出级别位INFO，默认为DEBUG。
    log4j.appender.file.Threshold=INFO
    
    #指定当前消息输出到jpm/log4j/log.log文件中
    log4j.appender.file.File=/jpm/log4j/log.log
    
    #指定按天来滚动日志文件
    log4j.appender.file.DatePattern=yyyy-MM-dd
    
    #配置日志信息的格式（布局）Layout是可以灵活地指定布局模式
    log4j.appender.file.layout=org.apache.log4j.PatternLayout
    
    #格式化日志，Log4j采用类似C语言中的printf函数的打印格式格式化日志信息
    log4j.appender.file.layout.ConversionPattern=[%d{yyyy-MM-ddHH:mm:ss}][%-5p][class:%c{1} method:%M(%L)]-%m%n
    
    #指定输出信息的编码
    log4j.appender.file.encoding=UTF-8

    #配置error日志信息输出目的地Appender
    #定义名为error的输出端是每天产生一个日志文件
    log4j.appender.error=org.apache.log4j.DailyRollingFileAppender
    
    #指定日志信息的最低输出级别位ERROR，默认为DEBUG。
    log4j.appender.error.Threshold=ERROR
    
    #指定当前消息输出到jpm/log4j/error.log文件中
    log4j.appender.error.File=/jpm/log4j/error.log
    
    #指定按月来滚动日志文件
    log4j.appender.error.DatePattern=yyyy-MM
    
    #配置日志信息的格式（布局）Layout是可以灵活地指定布局模式
    log4j.appender.error.layout=org.apache.log4j.PatternLayout
    
    #格式化日志，Log4j采用类似C语言中的printf函数的打印格式格式化日志信息
    log4j.appender.error.layout.ConversionPattern=[%d{yyyy-MM-ddHH:mm:ss}]
    [%-5p][jpm-%c{1}-%M(%L)]-%m%n
    
    #指定输出信息的编码
    log4j.appender.error.encoding=UTF-8

    #使某个功能的日志单独输出到指定的日志文件
    log4j.logger.saveUserLog=INFO,saveUserLog
    
    #该配置就是让job的日志只输出到自己指定的日志文件中,表示Logger不会在父Logger的appender里输出，默认为true。
    log4j.additivity.saveUserLog=false
    	 log4j.appender.saveUserLog=org.apache.log4j.DailyRollingFileAppender(FileAppender)
    log4j.appender.saveUserLog.File=/jpm/log4j/saveUserLog.log
    log4j.appender.saveUserLog.DatePattern=yyyy-MM-dd
    log4j.appender.saveUserLog.Append=true
    log4j.appender.saveUserLog.layout=org.apache.log4j.PatternLayout
    log4j.appender.saveUserLog.layout.ConversionPattern=%m%n
    log4j.appender.error.encoding=UTF-8
```

#### 2.6在代码中使用`Log4`

1. 得到记录器

使用Log4j，第一步就是获取日志记录器，这个记录器将负责控制日志信息。其语法为：

```delphi
public static Logger getLogger( String name)
```

1. 读取配置文件

当获得了日志记录器之后，第二步将配置 Log4j 环境，其语法为：

```scss
BasicConfigurator.configure()： 自动快速地使用缺省 Log4j 环境。
PropertyConfigurator.configure(String configFilename) ：读取使用 Java 的特性文件编写的配置文件。
DOMConfigurator.configure(String filename) ：读取XML形式的配置文件。
```

输出地址

如果是Web项目, 可通过修改Web容器的环境变量方式实现. 以 Tomcat 为例:

```properties
# log4j的配置文件支持服务器的vm环境变量, 格式类似${catalina.home} 
log4j.appender.R=org.apache.log4j.RollingFileAppender 
log4j.appender.R.File=${catalina.home}/logs/logs_tomcat.log 
log4j.appender.R.MaxFileSize=100MB 
```

`${catalina.home}`是在`${tomcat_home}/bin/catalina.sh`中通过-D参数设置的:

```bash
-Dcatalina.home="$CATALINA_HOME"
```

基于这个思路, 我们也可以向Web容器的VM参数中设置一个参数, 比如`-Dmylog.home="/Project/logs"`, 创建日志对象时即可使用.

#### 2.7`log4j`与数据库的连接